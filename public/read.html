<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta
			content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
			name="viewport"
		/>
		<meta content="yes" name="apple-mobile-web-app-capable" />
		<meta content="black" name="apple-mobile-web-app-status-bar-style" />
		<title>Kamishibai</title>
		<style>
			button {
				font-size: 2em;
				/* margin-right: 0.5em; */
			}
			.row {
				margin-bottom: 0.5em;
			}
			.a-link-page {
				min-width: 2em;
				padding: 3px;
				margin-right: 10px;
			}
			.div-img {
				width: 97%;
				margin-bottom: 0.5em;
			}
			.img-manga {
				width: 100%;
				min-width: 300px;
				min-height: 400px;
				border: 1px solid black;
				padding: 2px;
			}
		</style>
	</head>
	<body>
		<div class="row">
			<div><button onclick="goBrowse();">Browse</button></div>
			<div>
				Path: <span id="span-folder-name">{{ path }}</span>
			</div>
			<div>
				File: <span id="span-file-name">{{ filename }}</span>
			</div>
			<div>
				Page: <span id="span-page">{{ page }}</span> / <span id="span-page-total">{{ pageTotal }}</span>
			</div>
		</div>
		<noscript>
			<!-- hard coded page nav -->
			<div class="row">
				<a class="a-link-page" href="/read/xz?p={{ page - 5 }}">-5</a>
				<a class="a-link-page" href="/read/xz?p={{ page + 5 }}">+5</a>
				<a class="a-link-page" href="/read/xz?p={{ page - 10 }}">-10</a>
				<a class="a-link-page" href="/read/xz?p={{ page + 10 }}">+10</a>
				<a class="a-link-page" href="/read/xz?p={{ page - 25 }}">-25</a>
				<a class="a-link-page" href="/read/xz?p={{ page + 25 }}">+25</a>
				<a class="a-link-page" href="/read/xz?p={{ page - 50 }}">-50</a>
				<a class="a-link-page" href="/read/xz?p={{ page + 50 }}">+50</a>
				<a class="a-link-page" href="/read/xz?p={{ page - 100 }}">-100</a>
				<a class="a-link-page" href="/read/xz?p={{ page + 100 }}">+100</a>
			</div>
			<div class="row">
				<a class="a-link-page" href="/read/xz?p={{ page - 1 }}">Prev</a>
				<a class="a-link-page" href="/read/xz?p={{ page + 1 }}">Next</a>
			</div>
		</noscript>
		<div class="row" id="div-button-gopages"></div>
		<div class="row" id="div-button-navs-1"></div>
		<div class="row">
			<div class="div-img" id="div-img-1"><img src="images/spinner.gif" class="img-manga" id="img-1" /></div>
			<div id="div-button-navs-2"></div>
			<noscript>
				<div class="row">
					<a class="a-link-page" href="/read/xz?p=">Prev</a>
					<a class="a-link-page" href="/read/xz?p=">Next</a>
				</div>
			</noscript>
		</div>
		<script src="js/utilities.js"></script>
		<script src="js/alphanum-sort.js"></script>
		<script>
			// these needs to be ajax
			book_id = queryParams("book");
			pageTotal = 999;
			page = Number(queryParams("page"));
			if (isNaN(page) || page > 1) {
				page = 1;
			}

			window.onload = ready;
			window.onpopstate = onPopState;

			function ready() {
				updateButtons();

				var pg = queryParams("page");
				pg = Number(pg);
				if (isNaN(pg) || pg < 1) {
					// set as page 1 if not set
					history.replaceState({ page: 1 }, "Page 1");
					// reset to 1
					pg = 1;
					page = 1;
				} else {
					// load the page if provided
					history.replaceState({ page: pg }, "Page " + String(pg));
					// load this as the initial page
					page = pg;
				}

				// update image
				updatePage(pg);

				getUpdateBookInfo(book_id);

				// update page info
				document.getElementById("span-page").textContent = pg;
				document.getElementById("span-page-total").textContent = pageTotal;

				console.log("page ", page, "is ready");
			}

			function goPage(intStep, isAbsolutePage) {
				if (typeof intStep !== "number") return;
				if (isNaN(intStep)) return;

				var pg = 0;
				if (isAbsolutePage) {
					pg = intStep;
				} else {
					pg = page + intStep;
				}
				// dont move if invalid page
				if (pg < 1) return;

				// update global page value
				page = pg;

				// update url
				history.pushState({ page: page }, "Page " + pg);

				// update page rendering
				updatePage(pg);
			}

			function onPopState(event) {
				// event.location
				var state = event.state;
				page = state.page;
				updatePage(page);
			}

			function updateButtons() {
				// clear child elements
				var nodeDiv = document.getElementById("div-button-gopages");
				while (nodeDiv.firstChild) {
					nodeDiv.removeChild(nodeDiv.firstChild);
				}

				// recreate buttons
				var steps = [5, 10, 25, 50, 100];
				var btn, btn2, step;
				for (var i = 1; i < steps.length; i++) {
					step = steps[i];

					btn = genGoButton(-1 * step);
					nodeDiv.appendChild(btn);

					btn = genGoButton(step);
					nodeDiv.appendChild(btn);
				}

				// add next+prev buttons
				nodeDiv = document.getElementById("div-button-navs-1");
				btn = genGoButton(-1);
				nodeDiv.appendChild(btn);
				btn = genGoButton(1);
				nodeDiv.appendChild(btn);

				nodeDiv = document.getElementById("div-button-navs-2");
				btn = genGoButton(-1);
				nodeDiv.appendChild(btn);
				btn = genGoButton(1);
				nodeDiv.appendChild(btn);
			}

			function genGoButton(intStep) {
				if (typeof intStep !== "number") return;
				if (isNaN(intStep)) return;

				var btn = document.createElement("button");
				if (intStep === 1) {
					btn.innerText = "Next";
				} else if (intStep === -1) {
					btn.innerText = "Prev";
				} else if (intStep > 0) {
					btn.innerText = "+" + String(intStep);
				} else {
					btn.innerText = String(intStep);
				}
				btn.className = "a-link-page";
				btn.addEventListener("click", function() {
					goPage(intStep);
				});

				return btn;
			}

			function updatePage(p) {
				var pg = Number(p);
				if (isNaN(pg)) return;
				if (pg < 1) return;

				// update page info
				document.getElementById("span-page").textContent = pg;

				// update image src
				var el = document.getElementById("img-1");
				el.setAttribute("src", "/api/read/" + book_id + "/" + pg);
			}

			function goBrowse() {
				window.location = "/browse.html";
			}

			function getUpdateBookInfo(book_id) {
				var u = "/api/bookinfo/" + book_id;
				var p = {
					get: true,
					callback: function(str) {
						var bookInfo = JSON.parse(str);

						document.getElementById("span-file-name").innerText = bookInfo.title;
						pageTotal = bookInfo.pages;
					}
				};
				ajax(u, p);
			}
		</script>
	</body>
</html>
