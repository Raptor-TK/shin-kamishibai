<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta
			content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
			name="viewport"
		/>
		<meta content="yes" name="apple-mobile-web-app-capable" />
		<meta content="black" name="apple-mobile-web-app-status-bar-style" />
		<title>Kamishibai</title>
		<style>
			button {
				font-size: 2em;
				/* margin-right: 0.5em; */
			}
			.row {
				margin-bottom: 0.5em;
			}
			.a-link-page {
				min-width: 2em;
				padding: 3px;
				margin-right: 10px;
			}
			.div-img {
				width: 97%;
				margin-bottom: 0.5em;
			}
			.img-manga {
				width: 100%;
				min-width: 300px;
				min-height: 400px;
				border: 1px solid black;
				padding: 2px;
			}
		</style>
	</head>
	<body>
		<div class="row">
			<div id="div-go-browse"></div>
			<noscript>
				<div>
					<a class="a-link-page" href="/browse.html">Browse</a>
				</div>
			</noscript>
			<div>
				Author: <span id="span-book-author">{{ bookAuthor }}</span>
			</div>
			<div>
				Title: <span id="span-book-title">{{ bookTitle }}</span>
			</div>
			<div>
				Page: <span id="span-book-page">{{ bookPage }}</span> / <span id="span-book-pages">{{ bookPages }}</span>
			</div>
		</div>
		<noscript>
			<!-- hard coded page nav -->
			<div class="row">
				<a class="a-link-page" href="/read/{{ bookID }}?p={{ page - 5 }}">-5</a>
				<a class="a-link-page" href="/read/{{ bookID }}?p={{ page + 5 }}">+5</a>
				<a class="a-link-page" href="/read/{{ bookID }}?p={{ page - 10 }}">-10</a>
				<a class="a-link-page" href="/read/{{ bookID }}?p={{ page + 10 }}">+10</a>
				<a class="a-link-page" href="/read/{{ bookID }}?p={{ page - 25 }}">-25</a>
				<a class="a-link-page" href="/read/{{ bookID }}?p={{ page + 25 }}">+25</a>
				<a class="a-link-page" href="/read/{{ bookID }}?p={{ page - 50 }}">-50</a>
				<a class="a-link-page" href="/read/{{ bookID }}?p={{ page + 50 }}">+50</a>
				<a class="a-link-page" href="/read/{{ bookID }}?p={{ page - 100 }}">-100</a>
				<a class="a-link-page" href="/read/{{ bookID }}?p={{ page + 100 }}">+100</a>
			</div>
			<div class="row">
				<a class="a-link-page" href="/read/{{ bookID }}?p={{ page - 1 }}">Prev</a>
				<a class="a-link-page" href="/read/{{ bookID }}?p={{ page + 1 }}">Next</a>
			</div>
		</noscript>
		<div class="row" id="div-button-gopages"></div>
		<div class="row" id="div-button-navs-1"></div>
		<div class="row">
			<div class="div-img" id="div-img-1"><img src="images/spinner.gif" class="img-manga" id="img-1" onclick="goPage(1);" /></div>
			<div id="div-button-navs-2"></div>
			<noscript>
				<div class="row">
					<a class="a-link-page" href="/read/{{ bookID }}?p={{ page - 1 }}">Prev</a>
					<a class="a-link-page" href="/read/{{ bookID }}?p={{ page + 1 }}">Next</a>
				</div>
			</noscript>
		</div>
		<script src="js/utilities.js"></script>
		<script>
			// these needs to be ajax
			bookID = queryParams("book");
			pageTotal = 9999;
			page = Number(queryParams("page"));
			if (isNaN(page) || page > 1) {
				page = 1;
			}

			window.onload = ready;

			function ready() {
				updateButtons();

				var pg = queryParams("page");
				pg = Number(pg);
				if (isNaN(pg) || pg < 1) {
					// set as page 1 if not set

					// reset to 1
					pg = 1;
					page = 1;
				} else {
					// load the page if provided

					// load this as the initial page
					page = pg;
				}

				// update image
				updatePage(pg);

				getUpdateBookInfo(bookID);

				// update page info
				document.getElementById("span-book-page").textContent = pg;
				document.getElementById("span-book-pages").textContent = pageTotal;

				console.log("page ", page, "is ready");
			}

			function goPage(intStep, isAbsolutePage) {
				if (typeof intStep !== "number") return;
				if (isNaN(intStep)) return;

				var pg = 0;
				if (isAbsolutePage) {
					pg = intStep;
				} else {
					pg = page + intStep;
				}
				// dont move if invalid page
				if (pg < 1) return;
				if (pg > pageTotal) return;

				// update global page value
				page = pg;

				// replace url without adding history
				var rp = window.location.pathname + "?book=" + bookID + "&page=" + page;
				window.location.replace(rp);

				// update page rendering
				updatePage(pg);
			}

			function updateButtons() {
				// create go browse btn
				// clear child elements
				var nodeGB = document.getElementById("div-go-browse");
				while (nodeGB.firstChild) {
					nodeGB.removeChild(nodeGB.firstChild);
				}
				var btnGB = document.createElement("button");
				btnGB.innerHTML = "Browse";
				btnGB.onclick = goBrowse;
				nodeGB.appendChild(btnGB);

				// clear child elements
				var nodeDiv = document.getElementById("div-button-gopages");
				while (nodeDiv.firstChild) {
					nodeDiv.removeChild(nodeDiv.firstChild);
				}

				// recreate buttons
				var steps = [5, 10, 25, 50, 100];
				var btn, btn2, step;
				for (var i = 1; i < steps.length; i++) {
					step = steps[i];

					btn = genGoButton(-1 * step);
					nodeDiv.appendChild(btn);

					btn = genGoButton(step);
					nodeDiv.appendChild(btn);
				}

				// add next+prev buttons
				nodeDiv = document.getElementById("div-button-navs-1");
				btn = genGoButton(-1);
				nodeDiv.appendChild(btn);
				btn = genGoButton(1);
				nodeDiv.appendChild(btn);

				nodeDiv = document.getElementById("div-button-navs-2");
				btn = genGoButton(-1);
				nodeDiv.appendChild(btn);
				btn = genGoButton(1);
				nodeDiv.appendChild(btn);
			}

			function genGoButton(intStep) {
				if (typeof intStep !== "number") return;
				if (isNaN(intStep)) return;

				var btn = document.createElement("button");
				if (intStep === 1) {
					btn.innerText = "Next";
				} else if (intStep === -1) {
					btn.innerText = "Prev";
				} else if (intStep > 0) {
					btn.innerText = "+" + String(intStep);
				} else {
					btn.innerText = String(intStep);
				}
				btn.className = "a-link-page";
				btn.addEventListener("click", function() {
					goPage(intStep);
				});

				return btn;
			}

			function updatePage(p) {
				console.log("updatepage", p);
				var pg = Number(p);
				if (isNaN(pg)) return;
				if (pg < 1) return;

				// update page info
				document.getElementById("span-book-page").textContent = pg;

				// update image src
				var el = document.getElementById("img-1");
				el.setAttribute("src", "/api/read/" + bookID + "/" + pg);
			}

			function goBrowse() {
				window.location = "/browse.html";
			}

			function getUpdateBookInfo(_bookID) {
				var u = "/api/bookinfo/" + _bookID;
				var cb = function(str) {
					var bookInfo = JSON.parse(str);

					// update values on page
					document.getElementById("span-book-title").innerText = bookInfo.title;
					document.getElementById("span-book-author").innerText = bookInfo.author;
					document.getElementById("span-book-page").innerHTML = bookInfo.page;
					document.getElementById("span-book-pages").innerHTML = bookInfo.pages;

					// update page state
					pageTotal = bookInfo = bookInfo.pages;
				};
				ajaxGet(u, false, cb);
			}
		</script>
	</body>
</html>
